# HDF5 1.12+ Minimum Version Design

**Date:** 2026-02-05
**Issue:** https://github.com/tensor4all/tensor4all-hdf5-ffi/issues/11

## Summary

Simplify the codebase by requiring HDF5 1.12.0 or later, removing support for older versions. This fixes the runtime-loading ABI compatibility issues and significantly reduces code complexity.

## Background

### Problem

The current `runtime-loading` feature has a design flaw: it uses compile-time `#[cfg(feature = "1.12.0")]` to select which HDF5 APIs to use, but at runtime the actual HDF5 library version may differ from what was assumed at compile time.

Additionally, `hdf5-types` unconditionally depends on `hdf5-sys`, which defeats the purpose of runtime-loading mode (no compile-time linking).

### Target Environment

| Environment | HDF5 Version |
|-------------|--------------|
| Julia HDF5_jll (default) | **2.0.0** |
| Julia HDF5.jl (minimum) | **1.12+** |
| Python h5py (conda-forge) | **1.14.x** |

Since all target environments use HDF5 1.12+, supporting older versions adds complexity without benefit.

## Design

### 1. Remove hdf5-sys dependency from hdf5-types

**hdf5-types/Cargo.toml:**
```toml
[dependencies]
ascii = "1.1"
cfg-if = { workspace = true }
libc = { workspace = true }
num-complex = { workspace = true, optional = true }
half = { workspace = true, optional = true }
# hdf5-sys removed
```

**hdf5-types/references.rs:**
```rust
/// HDF5 reference type sizes (fixed by HDF5 specification)
pub const HOBJ_REF_SIZE: usize = 8;       // haddr_t (64-bit)
pub const HDSET_REG_REF_SIZE: usize = 12; // haddr_t + 4 bytes
pub const H5R_REF_SIZE: usize = 64;       // H5R_ref_t (1.12+)

#[derive(Copy, Clone, Debug, PartialEq, Eq)]
pub enum Reference {
    Object,
    Region,
    Std,  // Always available (no cfg gate)
}

impl Reference {
    pub fn size(self) -> usize {
        match self {
            Self::Object => HOBJ_REF_SIZE,
            Self::Region => HDSET_REG_REF_SIZE,
            Self::Std => H5R_REF_SIZE,
        }
    }
}
```

**hdf5-types/lib.rs:**
```rust
// Always use libc for memory allocation
pub unsafe fn h5_alloc(n: usize) -> *mut c_void {
    libc::malloc(n)
}

pub unsafe fn h5_free(ptr: *mut c_void) {
    libc::free(ptr);
}
```

### 2. Simplify hdf5 crate to use only 1.12+ APIs

**Remove from sys/runtime.rs:**
- `H5Oget_info1`, `H5Oget_info_by_name1`
- `H5Oget_info2`, `H5Oget_info_by_name2`
- `H5Oopen_by_addr`
- `H5O_info1_t`
- `H5Literate1` alias

**Keep in sys/runtime.rs:**
- `H5O_info2_t`, `H5O_token_t`
- `H5Oget_info3`, `H5Oget_info_by_name3`
- `H5Oopen_by_token`
- `H5Literate2`, `H5L_info2_t`

**Simplify location.rs:**
```rust
// Remove all cfg gates, use 1.12+ APIs directly
use crate::sys::h5o::{H5O_info2_t, H5O_token_t, H5Oget_info3, H5Oopen_by_token};

pub struct LocationToken(pub(crate) H5O_token_t);

fn H5O_get_info(loc_id: hid_t, full: bool) -> Result<LocationInfo> {
    let mut info = MaybeUninit::uninit();
    h5call!(H5Oget_info3(loc_id, info.as_mut_ptr(), info_fields(full)))?;
    Ok(unsafe { info.assume_init() }.into())
}

fn H5O_open_by_token(loc_id: hid_t, token: LocationToken) -> Result<Location> {
    Location::from_id(h5call!(H5Oopen_by_token(loc_id, token.0))?)
}
```

### 3. Add version check at initialization

```rust
fn check_hdf5_version() -> Result<()> {
    let (major, minor, _) = library_version();
    if major < 1 || (major == 1 && minor < 12) {
        return Err(Error::from(format!(
            "HDF5 {}.{} is not supported. Minimum required: 1.12.0",
            major, minor
        )));
    }
    Ok(())
}
```

### 4. Clean up feature flags

**Remove version-gated cfg attributes:**
- `#[cfg(feature = "1.10.3")]`
- `#[cfg(not(feature = "1.10.3"))]`
- `#[cfg(all(feature = "1.10.3", not(feature = "1.12.0")))]`
- `#[cfg(not(feature = "1.12.0"))]`

**Keep only:**
- `#[cfg(feature = "1.12.0")]` where needed for forward compatibility
- `#[cfg(feature = "link")]` vs `#[cfg(feature = "runtime-loading")]`

## Files to Modify

| File | Changes |
|------|---------|
| `hdf5-types/Cargo.toml` | Remove `hdf5-sys` dependency |
| `hdf5-types/build.rs` | Remove hdf5-sys related code |
| `hdf5-types/src/lib.rs` | Simplify memory allocation |
| `hdf5-types/src/references.rs` | Use constants for sizes |
| `hdf5/src/sys/runtime.rs` | Remove v1 APIs, add version check |
| `hdf5/src/sys/mod.rs` | Update exports |
| `hdf5/src/hl/location.rs` | Remove cfg branches |
| `hdf5/src/hl/group.rs` | Use H5Literate2 |
| `hdf5/src/lib.rs` | Update version check |
| `README.md` | Document minimum version |

## Testing

1. All tests with HDF5 1.12+ (link mode)
2. All tests with HDF5 1.14.x (runtime-loading mode)
3. Integration test with tensor4all-rs
4. Version check test for < 1.12.0 rejection

## Breaking Changes

- Minimum HDF5 version raised from 1.8.4 to 1.12.0
- `hdf5-types` no longer depends on `hdf5-sys`
- Removed deprecated v1 API support

## References

- [HDF5 API Compatibility Macros](https://docs.hdfgroup.org/hdf5/develop/api-compat-macros.html)
- [HDF5 Reference Types](https://docs.hdfgroup.org/hdf5/v1_12/structhdset__reg__ref__t.html)
- [Julia HDF5.jl](https://juliaio.github.io/HDF5.jl/stable/)
